!function(){"use strict";angular.module("kt.pano").controller("ktOverviewCtrl",["$scope","$rootScope","$q","$state","$templateRequest","$window","$stateParams","ktDataHelper","ktAnalyticsService","ktValueFactory","ktEchartTheme1","ktSweetAlert","ktLogService","ktInstitutionalInfoService","ktNewProductService","ktProductRateService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){a.updateDate="获取中...",a.updateDateTo="获取中...",a.getLife=h.getLife,a.updateTime="更新时间：",a.timeRange="时间范围：",a.findPopover={templateUrl:"views/tooltips/find_popover.html",title:"提示"},a.showFindPopover=b.showFindPopover,a.findPopoverConfirm=function(){a.showFindPopover=!1,b.showFindPopover=!1},a.goTo=function(a,b){a.stopPropagation(),window.open(b,"_blank")},a.moreHidden=function(){var a=b.user||{};return"normal"!==a.group},a.getRate=function(a,b){return _.isNil(a)&&_.isNil(b)?"-":_.isNil(a)&&!_.isNil(b)?b.toFixed(2)+"%":_.isNil(b)&&!_.isNil(a)?a.toFixed(2)+"%":a===b?a.toFixed(2)+"%":a.toFixed(2)+"%-"+b.toFixed(2)+"%"};var q=k.color,r={text:"努力加载中...",color:"#3d4351",textColor:"#3d4351"},s={yAxis:{axisLine:{show:!1,lineStyle:{width:1,color:"#afb7d0"}},splitLine:{show:!0,lineStyle:{color:["#f3f3f3"],width:1,type:"solid"}},splitArea:{show:!1,areaStyle:{color:["rgba(250,250,250,0.3)","rgba(200,200,200,0.3)"]}}},grid:{right:60},tooltip:{valueType:"rmb"}},t=a.rateAmountChart={chartOptions:{},yAxis:"amount",yAxisFormat:"rmb",xAxis:"rate",xAxisFormat:"percent2",color:["#dd4444"],tab:"last7days",list:[]};t.updateDataView=function(b,c){function e(){var a=f.data,b=_.map(a,function(a){return a[2]}),c=h.chartOptions("#rateAmountChart",b),e=_.map(a,function(a){return a[0]}),i=_.map(a,function(a){return a[1]}),k=function(a){var b=Math.min(Math.sqrt(a/5e8)+.1,2.5);return b=Math.max(.25,b),25*b};f.chartOptions=$.extend(!0,{},s,c,{onclick:function(a){var b=d.href("pano.institutions.detail",{id:a.seriesName});window.open(b,"_blank")},legend:{data:b},tooltip:{axisPointer:{axis:"auto",type:"line"},trigger:"item",triggerOn:"mousemove",formatter:function(a){var b='<div class="f1_2rem chart-tooltip-title" style="border-bottom: 1px solid rgba(255,255,255,.3);padding-bottom: 5px;margin-bottom:5px;">'+a.value[2]+'</div><table class="f1_2rem chart-tooltip-table"><tr><td class="justify">加权收益率：</td><td>'+j(a.value[0],f.xAxisFormat)+'</td></tr><tr><td class="justify">发行量：</td><td>'+j(a.value[1],f.yAxisFormat)+"</td></tr>";return b},xAxisFormat:f.xAxisFormat,yAxisFormat:f.yAxisFormat},visualMap:[{show:!1,dimension:1,min:_.min(i),max:_.max(i),precision:1,inRange:{symbolSize:[5,50]},outOfRange:{symbolSize:[5,50],color:["rgba(0,0,0,.2)"]}}],yAxis:{name:"发行量（万元）",boundaryGap:!0,type:"log"},xAxis:{max:function(){var a=_.max(e),b=_.round(a-(0|a),2);return _.ceil(a)+1*(b>.8)}(),min:function(){var a=_.min(e),b=_.round(a-(0|a),2);return _.floor(a)-1*(b<.3)}(),type:"value",name:"收益率",nameLocation:"end",nameGap:10,boundaryGap:!1},series:_.map(a,function(a){return{name:a[2],showEffectOn:"emphasis",itemStyle:{normal:{opacity:.7}},type:"effectScatter",symbolSize:function(a){return k(a[1])},rippleEffect:{period:8,scale:1.5,brushType:"fill"},data:[a]}})}),g&&g.hideLoading()}var f=this,g=f.echart=echarts.getInstanceByDom($("#rateAmountChart")[0]);c&&g&&(g.hideLoading(),g.showLoading(r)),i.get($.extend({content:"overview",chart:"summary"},b||{}),function(b){f.data=h.sortByChars(b.stat),b.crawled_at&&(a.updateDate=moment(b.crawled_at).subtract(6,"d").format("YYYY-MM-DD")+" ~ "+moment(b.crawled_at).format("YYYY-MM-DD"),a.updateDateTo=moment(b.crawled_at).format("YYYY-MM-DD")),e()})},a.$watch("rateAmountChart.tab",function(a,c){_.isUndefined(a)||a===c||(t.updateDataView({chart:"last7days"===a?"summary":"history"},!0),b.bdTrack(["总览页","last7days"===a?"近七日":"历史平均周","各平台发行量收益率统计"]))}),a.alertMore=function(){b.bdTrack(["总览页","交易所产品发行登记管理核心系统","详情"]),l.swal({title:'<h4 class="title-more">详情</h4><div class="more-table"><table><tbody><tr><td><span>多种产品全支持</span></td><td><span>产品发行自动化</span></td><td><span>合规发行支持 </span></td></tr><tr><td><span>产品信息多维展示 </span></td><td><span>事件智能提醒</span></td><td><span>权限/审批灵活可配 </span></td></tr></tbody></table></div><p class="alert-moreCode">如果想了解更多信息，欢迎与我们联系：)</p>',text:'<span class="moreCode-pano"><img src="../../images/moreCode.72e2e9ef.png"></span>',html:!0})},a.bdRecord=function(a){m.get({anchor:"action=总览页-下载-"+a}),bdTrack(["总览页","下载",a])};var u=a.durationAmountChart={chartOptions:{},yAxis:"amount",yAxisFormat:"rmb",yAxisFormat2:"percent2",xAxis:"_id",xAxisFormat:null,list:[]};u.updateDataView=function(){function a(){var a=b.data1,c=b.data2,d=_.concat(_.map(a.data,"name"),_.map(c.data,"name")),e=_.concat(q.slice(0,2),q.slice(0,2)),f=h.chartOptions("#durationAmountChart",d);b.chartOptions=$.extend(!0,{},s,f,{color:e,legend:{data:d},tooltip:{titlePrefix:"产品期限：",xAxisFormat:b.xAxisFormat,yAxisFormat:b.yAxisFormat+"{0,1}|"+b.yAxisFormat2+"{2,3}"},yAxis:[{name:"发行量（万元）",textStyle:{color:"#666b76",fontSize:10},axisLabel:{formatter:function(a){var b=u.yAxisFormat;return j(a,b).toString().replace(/%|万元|百万|元/g,"")}}},{name:"收益率（%）",textStyle:{color:"#666b76",fontSize:10},position:"right",axisLabel:{formatter:function(a){var b=u.yAxisFormat2;return j(a,b).toString().replace(/%|万元|百万|元/g,"")}},interval:1,max:h.getAxisMax(c.data),min:0}],xAxis:{type:"category",boundaryGap:!0,axisLabel:{formatter:function(a){var b=u.xAxisFormat;return j(a,b)}},nameLocation:"end",nameGap:10,data:h.chartAxisFormat(a.xAxis,"MY")},series:_.concat(_.map(a.data,function(a){return{name:a.name,type:"bar",itemStyle:{normal:{opacity:.8}},barMaxWidth:40,data:a.data}}),_.map(c.data,function(a){return{name:a.name,type:"line",yAxisIndex:1,markLine:{data:h.getMarkLineCoords(a.data)},smooth:!1,data:a.data}}))})}var b=this,d=i.get({content:"overview",chart:"circulation"}).$promise,e=i.get({content:"overview",chart:"rate"}).$promise;c.all([d,e]).then(function(c){b.data1=h.chartDataPrune(c[0].stat),b.data2=h.chartDataPrune(c[1].stat),_.each(b.data1.data,function(a){var c=a.name.match(/上周期（(.*)）/),d=a.name.match(/本周期（(.*)）/);b.lastPeriod=c?"上周期："+c[1]:b.lastPeriod,b.thisPeriod=d?"本周期："+d[1]:b.thisPeriod}),b.data1.data=_.map(b.data1.data,function(a){return{name:a.name.replace(/周期（.+）/g,"周期发行量"),data:a.data}}),b.data2.data=_.map(b.data2.data,function(a){return{name:a.name.replace(/周期（.+）/g,"周期收益率"),data:a.data}}),a()})};var v=a.platformAssetTypeChart={chartOptions:{},yAxis:"amount",updateDate:"获取中...",yAxisFormat:"percent2",xAxis:"_id",color:h.getDimentionSpecialColor("asset_type"),xAxisFormat:null,list:[]};v.updateDataView=function(){function a(){var a=b.data,c=_.map(a.data,"name"),d=h.chartOptions("#platformAssetTypeChart",c),f=b.color||q.slice(0,c.length);b.updateDate=_.first(a.xAxis)+" ~ "+moment(_.last(a.xAxis)).weekday(6).format("YYYY-MM-DD");var g;e("views/tooltips/echart_table_tooltip.html").then(function(a){g=_.template(a,{imports:{ktValueFactory:j}})}),b.chartOptions=$.extend(!0,{},s,d,{color:_.reverse(f.slice(0)),legend:{data:c},tooltip:{reverse:!0,xAxisFormat:b.xAxisFormat,yAxisFormat:b.yAxisFormat,formatter:function(b){if(!g)return"";var c=_.reverse(b),d=c[0].name;d+=" ~ "+moment(d).weekday(6).format("YYYY-MM-DD"),_.each(c,function(b){b.amount=a.data[b.seriesIndex].amount[b.dataIndex],b.rate=a.data[b.seriesIndex].rate[b.dataIndex]});var e=g({title:d,params:c,color:_.reverse(f.slice(0))});return e}},yAxis:{name:"类型占比（%）",max:100,min:0},xAxis:{type:"category",name:"周",nameLocation:"end",nameGap:10,axisLabel:{interval:"auto"},boundaryGap:!0,data:a.xAxis},series:_.map(_.reverse(a.data),function(a){return{name:a.name,type:"bar",itemStyle:{normal:{opacity:.8}},stack:"类型占比",barMaxWidth:40,data:a.amount_percent}})})}var b=this;i.get({content:"overview",chart:"circulation_ratio"},function(c){b.data=h.chartDataToPercent(c.stat,"amount"),a()})},t.updateDataView(),u.updateDataView(),v.updateDataView();var w=a.pageSize=10;a.nextFromPage=function(){a.from_page<a.max_from_page&&(a.from_page+=1,b.bdTrack(["总览页","翻页","平台近7日发行量"]))},a.preFromPage=function(){a.from_page>0&&(a.from_page-=1,b.bdTrack(["总览页","翻页","平台近7日发行量"]))},a.nextExchangePage=function(){a.exchange_page<a.max_exchange_page&&(a.exchange_page+=1,b.bdTrack(["总览页","翻页","交易所近7日发行量"]))},a.preExchangePage=function(){a.exchange_page>0&&(a.exchange_page-=1,b.bdTrack(["总览页","翻页","交易所近7日发行量"]))},a.from_page=0,a.exchange_page=0,a.max_from_page=0,a.max_exchange_page=0,a.fromAmountsFilter=function(b,c){return c>=a.from_page*w&&c<a.from_page*w+w},a.exchangeAmountsFilter=function(b,c){return c>=a.exchange_page*w&&c<a.exchange_page*w+w},n.get({},function(b){a.amounts=b.platform,b.platform.all_amount.length>0&&(a.all_amounts=b.platform.business_borrowings.slice(0,5))}),a.topAmounts=[],a.topPercents=[],a.ams=[],o.get({bond_or_am:"bond"},function(b){a.upDateBond=b.res.updated_at,a.topAmounts=b.res.top_amount_res,a.topPercents=b.res.top_percent_res}),o.get({bond_or_am:"am"},function(b){a.upDateAm=b.res.updated_at,b.res.am_res.length>0&&(a.ams=b.res.am_res.slice(0,5))}),a.newProductUpdateTime=function(){return a.topAmounts.length||a.topPercents.length?a.ams.length?+new Date(a.upDateBond)>+new Date(a.upDateAm)?a.upDateBond:a.upDateAm:a.upDateBond:a.upDateAm||"-"},p.get({type:"bond"},function(b){a.rateDatas=b.res,a.rateThTitles=_.map(b.res.list[0].set,"group"),a.obRateTime=b.res.begin_date+"至"+b.res.end_date;var c=window.devicePixelRatio||window.webkitDevicePixelRatio||window.mozDevicePixelRatio||window.msDevicePixelRatio;setTimeout(function(){var a=$("#obRateTable"),b=a.width(),d=a.height(),e=document.createElement("canvas");e.width=b*c,e.height=d*c,e.style.width=b+"px",e.style.height=d+"px";var f=e.getContext("2d");c>1&&f.scale(2,2),html2canvas(a[0],{onrendered:function(b){a.append(b)}})},1e3)}),p.get({type:"am"},function(b){a.assetDatas=b.res,a.asserRateTime=b.res.begin_date+"至"+b.res.end_date,a.assetThTitles=_.map(b.res.list[0].set,"group");var c=window.devicePixelRatio||window.webkitDevicePixelRatio||window.mozDevicePixelRatio||window.msDevicePixelRatio;setTimeout(function(){var a=$("#assetRateTable"),b=a.width(),d=a.height(),e=document.createElement("canvas");e.width=b*c,e.height=d*c,e.style.width=b+"px",e.style.height=d+"px";var f=e.getContext("2d");c>1&&f.scale(2,2),html2canvas(a[0],{onrendered:function(b){a.append(b)}})},1e3)}),i.get({content:"hodgepodge"},function(b){a.notices=b.notices,a.from_amounts=_.map(b.froms,function(a){return{name:a[0],amount:a[1]}}),a.max_from_page=Math.ceil(b.froms.length/w)-1,a.exchange_amounts=_.map(b.exchanges,function(a){return{name:a[0],amount:a[1]}}),a.max_exchange_page=Math.ceil(b.exchanges.length/w)-1,a.reports=b.reports,a.compass_assets_am=b.compass_ams,a.compass_assets_bond=b.compass_bonds,a.fame_assets_am=b.fame_ams,a.fame_assets_bond=b.fame_bonds})}])}();